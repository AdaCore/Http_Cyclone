\newlength\hatchdistance
\hatchdistance=10pt
\pgfdeclarepatternformonly[\hatchdistance,2pt]{north east hatch}% name
    {\pgfqpoint{-1pt}{-1pt}}% below left
    {\pgfqpoint{\hatchdistance}{\hatchdistance}}% above right
    {\pgfpoint{\hatchdistance-1pt}{\hatchdistance-1pt}}%
    {
        \pgfsetcolor{orange!40}
        \pgfsetlinewidth{2pt}
        \pgfpathmoveto{\pgfqpoint{0pt}{0pt}}
        \pgfpathlineto{\pgfqpoint{\hatchdistance}{\hatchdistance}}
        \pgfusepath{stroke}
    }
\begin{figure}
    \centering\begin{tikzpicture}[x=.12\textwidth,y=.55cm,
        application/.style={font=\sffamily\scriptsize,
                            draw,
                            minimum width=.117\textwidth,
                            minimum height=.5cm},
        session/.style={font=\sffamily\scriptsize,
                        draw,
                        minimum width=.717\textwidth,
                        minimum height=.5cm},
        transport/.style={font=\sffamily\scriptsize,
                          draw,
                          minimum width=.297\textwidth,
                          minimum height=.5cm},
        network/.style={font=\sffamily\scriptsize,
                        draw,
                        minimum width=.357\textwidth,
                        minimum height=.5cm},
        datalink/.style={font=\sffamily\scriptsize,
                         draw,
                         minimum width=.141\textwidth,
                         minimum height=.5cm}
    ]
        \node[application] at (0,10) {HTTP};
        \node[application] at (1,10) {HTTP/2};
        \node[application] at (2,10) {MQTT};
        \node[application] at (3,10) {MQTT-SN};
        \node[application] at (4,10) {CoAP};
        \node[application] (CoinA) at (5,10) {FTP};
        \node[application] at (0,9)  {SMTP};
        \node[application] at (1,9)  {SNTP};
        \node[application] at (2,9)  {DNS};
        \node[application] at (3,9)  {NetBIOS};
        \node[application] at (4,9)  {SNMPv3};
        \node[application] at (5,9)  {TFTP};
        \node[application, minimum width=.237\textwidth] at (.5,8) {WebSocket};
        \node[application] at (2,8)  {mDNS};
        \node[application] at (3,8)  {DNS-SD};
        \node[application] at (4,8)  {DHCP};
        \node[application] (CoinB) at (5,8)  {DHCPv6};
        \node[session, fill=green!70!yellow!20] (Socket) at (2.5, 7) {Socket};
        \node[transport, preaction={fill, green!70!yellow!20}, pattern=north east hatch, pattern color=orange!40] at (.75,6) {TCP};
        \node[transport, fill=orange!40] at (3.25,6) {UDP};
        \node[application, fill=orange!40] (RAW) at (5,6) {RAW};
        \node[network, fill=orange!40] at (1, 5) {IPv4};
        \node[network, fill=orange!40] (IPv6) at (4, 5) {IPv6};
        \node[application, fill=orange!40] at (0,4) {ARP};
        \node[application, fill=orange!40] at (1,4) {Auto-IP};
        \node[application, fill=orange!40] at (2,4) {NDP};
        \node[application, fill=orange!40] at (3,4) {SLAAC};
        \node[application, fill=orange!40] (ICMP) at (4,4) {ICMP};
        \node[application, fill=orange!40] (MLDv1) at (5,4) {MLDv1};
        \node[datalink, fill=orange!40] at (0.10, 3) {Ethernet};
        \node[datalink, fill=orange!40] at (1.3, 3) {Wi-Fi};
        \node[datalink, fill=orange!40] at (2.5, 3) {PPP};
        \node[datalink, fill=orange!40] at (3.7, 3) {USB/RNDIS};
        \node[datalink, fill=orange!40] (G3) at (4.9, 3) {G3-PLC};


        \draw[decorate, decoration={brace}, line width=.5pt]
            ([xshift=2pt]CoinA.north east) -- ([xshift=2pt]CoinB.south east)
            node [midway, anchor=west, font=\sffamily\scriptsize] {Application layer};
        \draw[decorate, decoration={brace}, line width=.5pt]
            ([xshift=2pt]Socket.north east) -- ([xshift=2pt]Socket.south east)
            node [midway, anchor=west, font=\sffamily\scriptsize] {Session layer};
        \draw[decorate, decoration={brace}, line width=.5pt]
            ([xshift=2pt]RAW.north east) -- ([xshift=2pt]RAW.south east)
            node [midway, anchor=west, font=\sffamily\scriptsize] {Transport layer};
        \draw[decorate, decoration={brace}, line width=.5pt]
            ([xshift=2pt]IPv6.north east) -- ([xshift=2pt]MLDv1.south east)
            node [midway, anchor=west, font=\sffamily\scriptsize] {Network layer};
        \draw[decorate, decoration={brace}, line width=.5pt]
            ([xshift=2pt]G3.north east) -- ([xshift=2pt]G3.south east)
            node [midway, anchor=west, font=\sffamily\scriptsize] {Data Link layer};
    \end{tikzpicture}

    \caption{Overview of the TCP/IP CycloneTCP stack in the OSI model. Green parts represent
             what have been translated in SPARK and in orange the underlying untrusted part written in C.}
    \label{Fig:TcpStack}
\end{figure}